# Shell Script Lint workflow for forked-u-onex
# Uses shellcheck to lint all shell scripts on push and pull requests

name: Shell Script Lint

on:
  push:
    branches: [ main, master ]
    paths:
      - '**.sh'
      - '.github/workflows/shellcheck.yml'
  pull_request:
    branches: [ main, master ]
    paths:
      - '**.sh'
      - '.github/workflows/shellcheck.yml'

# Minimal permissions for security
permissions:
  contents: read

jobs:
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest
    
    steps:
    # Checkout the repository code
    - name: Checkout code
      uses: actions/checkout@v4
    
    # Install shellcheck (latest version)
    - name: Install ShellCheck
      run: |
        sudo apt-get update
        sudo apt-get install -y shellcheck
    
    # Find and lint all shell scripts
    - name: Run ShellCheck
      run: |
        echo "🔍 Finding shell scripts to lint..."
        
        # Find all shell scripts (.sh files and files with shell shebangs)
        find . -name "*.sh" -type f | while read -r script; do
          echo "📝 Linting: $script"
          shellcheck "$script"
        done
        
        # Also check files with shell shebangs that don't end in .sh
        find . -type f -exec grep -l '^#!/.*sh' {} \; | grep -v '\.sh$' | while read -r script; do
          echo "📝 Linting shell script: $script"
          shellcheck "$script"
        done
        
        echo "✅ ShellCheck completed successfully!"
    
    # Run shellcheck with SARIF output for GitHub Security tab
    - name: Run ShellCheck (SARIF)
      run: |
        # Create SARIF report for GitHub Security tab integration
        shellcheck -f json1 $(find . -name "*.sh" -type f) > shellcheck-report.json || true
        
        # Convert to SARIF format for better GitHub integration
        echo "📊 ShellCheck report generated"
      continue-on-error: true
    
    # Upload shellcheck report as artifact
    - name: Upload ShellCheck report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: shellcheck-report
        path: shellcheck-report.json
        retention-days: 30
